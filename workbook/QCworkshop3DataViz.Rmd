---
title:  "Data Visualisation"
author: "Emma Rand"
output:
  html_document:
    toc: true
    depth: 3
    toc_float:
      collapsed: false
      smooth_scroll: false
    theme: yeti
  word_document: default
---
![](../../pics/58I.png)

  

# Introduction

## Aims
In the last of our four taught Autumn term Q&C workshops you get practice choosing appropriate figures and creating them with ggplot. In previous 58I workshops as well as those in 06C and 08C, you have often needed to chose and apply analyses for given scenarios and data. Here you will again be given the scenario and data but also the code to import and analyse it so that you can focus selecting and crafting figures.

## Objectives 
By carrying out the Prior independent learning, working through workbook examples during the workshop workshop and completing follow-up independent study the successful student will be able to:

* explain what is important in choosing a figure
* determine which variables are best mapped to which elements of a figure
* explain the fundamentals of ggplot and recognise it as a 'tidy' package
* create, with ggplot, appropriate figures to accompany lm and glm analyses of up to three explanatory variables which show the data, the main statistical model and the results of any post-hoc testing as appropriate.


# Prior Independent Learning

Carry out [Datacamp's Data Visualization with ggplot2 (Part 1)](https://www.datacamp.com/courses/data-visualization-with-ggplot2-1). 

In addition, familiarise yourself with this material: [Data visualisation](../slides/Data visualisation.pdf)

# Workbook

## About the Workbook

I recommend you do as many of the examples as you can. For each example you should:

* run the code to read in, summarise and analyse the data. You can assume assumptions are met. Basic interpretations are given.
* think about the answers to any questions
* consider which variable to match to which plot elements
* think about what the analysis is trying to show and chose a figure that agrees (i.e., what geoms should be used)
* follow any instructions

Start by making ggplot and the summarySE function available to R
```{r, message=FALSE, warning=FALSE}
library(ggplot2)
library(Rmisc)
```



### Nicotinic acid on adipocytes

This example is about the effect of nicotinic acid treatment on the adiponectin secretion of an adipocytes cell line.
Adiponectin is exclusively secreted from adipose tissue and modulates a number of metabolic processes. Nicotinic acid can affect adiponectin secretion. 3T3-L1 adipocytes were treated with nicotinic acid or with a control treatment and adiponectin concentration (pg/mL) measured. The data are in [adipocytes.txt](../data/adipocytes.txt). Each row represents an independent sample of adipocytes and the first column gives the concentration adiponectin and the second column indicates whether they were treated with nicotinic acid or not.

![](../../pics/W.png) Save a copy of [adipocytes.txt](../data/adipocytes.txt). 

![](../../pics/R.png) Read it in and analyse like this:

```{r, message=FALSE, warning=FALSE}
# Read in file
adip <- read.table("../data/adipocytes.txt", header = T)

# Summarise the data
adipsummary <- summarySE(adip, measurevar = "adiponectin", groupvars = c("treatment"))

# Build and examine and linear model of adiponectin explained by treatment
mod <- lm(adiponectin ~ treatment, data = adip)
summary(mod)
# basic interpretation
# the mean for the control is 5.5 +/- 0.42 and that for the nicotinic acid treated cells is siginfcantly higher at 7.5

# basic model evaluation
# this model explains 28% of the variation in the response. the different treatments account for 28% of the variance in adiponectin, the rest is unexplained (or random)

```

![](../../pics/R.png) Create a barplot like this of the data:

```{r echo = FALSE, fig.height=4, fig.width=4, message=FALSE, warning=FALSE}
#============== WORKBOOK EXAMPLE ==============#

ggplot(adipsummary, aes(x = treatment,y = adiponectin) ) +
  geom_bar(stat = "identity", fill = "white", color= "black")+
  geom_errorbar(aes(ymin = adiponectin - se, ymax = adiponectin + se), width = .1) +
  ylim(0, 10) +
  ylab("Adiponectin (pg/mL)") +
  xlab("Treatment") +
  scale_x_discrete(labels = c("Control", "Adiponectin"))

```



* *Tip* You will need to use the data summary rather than the raw data 
* *Tip* [`scale_x_discrete()`](https://ggplot2.tidyverse.org/reference/scale_discrete.html) allows you to alter the x-axis labels


![](../../pics/R.png) Instead of using bars for the means, use points

```{r echo = FALSE, results = "hide", warning = FALSE, message = FALSE, eval = FALSE}
#============== WORKBOOK EXAMPLE ==============#

ggplot(adipsummary, aes(x = treatment,y = adiponectin) ) +
  geom_point() +
  geom_errorbar(aes(ymin = adiponectin - se, ymax = adiponectin + se), width = .1) +
  ylim(0, 10) +
  ylab("Adiponectin (pg/mL)") +
  xlab("Treatment") +
  scale_x_discrete(labels = c("Control", "Adiponectin"))
```

* *Tip* You just need a different geom

![](../../pics/R.png) Format your figure by making the background plain and white, including axes and annotating with the results of the analysis. It should look like this:

```{r echo = FALSE, fig.height=4, fig.width=4, message=FALSE, warning=FALSE}
#============== WORKBOOK EXAMPLE ==============#

ggplot(adipsummary, aes(x = treatment,y = adiponectin) ) +
  geom_point() +
  geom_errorbar(aes(ymin = adiponectin - se, ymax = adiponectin + se), width = .1) +
  ylim(0, 10) +
  ylab("Adiponectin (pg/mL)") +
  xlab("Treatment") +
  scale_x_discrete(labels = c("Control", "Adiponectin"))+
  annotate("segment", x = 1, xend = 1, 
           y = 8.8, yend = 8.5,
           colour = "black") +
  annotate("segment", x = 2, xend = 2, 
           y = 8.8, yend = 8.5,
           colour = "black") +
  annotate("segment", x = 1, xend = 2, 
           y = 8.8, yend = 8.8,
           colour = "black") +
  annotate("text", x = 1.5,  y = 9, 
           label = "**", size = 7) +
  theme(panel.background = element_rect(fill = "white"))+
  theme(axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"))
```

* *Tip* You can use [`annotate("segment", ...)`](https://ggplot2.tidyverse.org/reference/annotate.html) and [`annotate("text", ...)`](https://ggplot2.tidyverse.org/reference/annotate.html). You used these in [BIO00017C](http://www-users.york.ac.uk/~er13/17C%20-%202018.yrk/pracs/06One-wayAnovaAndKW.html#illustrating_2) or [BIO00008C](http://www-users.york.ac.uk/~er13/08C%20-%202018.yrk/pracs/04ANOVA.html#illustrating)
* *Tip* [`theme()`](https://ggplot2.tidyverse.org/reference/theme.html) allows you to modify individual components of a `theme` - the way a plot looks.

### Comparing standardization Methods

Researchers measure concentration of long-chain hydrocarbons, in a single unknown sample by three methods of standardisation using gas chromatography. They wish to determine whether the three standardisations methods give the same concentrations. The data are given in [analyte.txt](../data/analyte.txt) and the first column gives the analyte concentration determined in parts per million and the second column indicates the standardisations method 'standard', 'internal standard' or 'standard addition'
Addition)

![](../../pics/W.png) Save a copy of [analyte.txt](../data/analyte.txt). 

![](../../pics/R.png) Read it in and analyse like this:

```{r, message=FALSE, warning=FALSE}
# Read in file
analyte <- read.table("../data/analyte.txt",header = T)

# Summarise the data
analytesummary <- summarySE(analyte, measurevar = "ppm", groupvars = c("method"))

# Build and examine and linear model of analyte concentration explained by method
mod <- lm(ppm ~ method, data = analyte)
summary(mod)

# basic interpretation
# the mean for internal_standard is 170.42 +/- 2.761 that for standard is higher but not siginifcantly so. standard_additional is  signifcantly lower than standard_internal

# basic model evaluation
# this model explains 90% of the variation in the response. the different methods account for 90% of the variance in ppm, the rest is unexplained (or random)
```

Here we will squeeze in a little bit of statistics in R you've not seen before. You should remember that we used `TukeyHSD()` on `aov` objects for finding which comparisons were significant when we had more than two groups. We can do the same with the `lsmeans()` function from the `lsmeans` package. It has much greater capability therefore is more complex to use but you will still be able to understand the output if you understand post-hoc tests in general

![](../../pics/R.png) Load `lsmeans` package:
```{r, message=FALSE, warning=FALSE}
library(lsmeans)
```

![](../../pics/R.png) Use `lsmeans()` like this

```{r, message=FALSE, warning=FALSE}
lsmeans(mod, pairwise ~ method)
```

![](../../pics/R.png) For this figure, plot **all** of the data points as well as the 'model' and annotate for the post-hoc results using a style of your choosing. You might want to start your y axis higher than zero. 

```{r echo=FALSE,results="hide",warning=FALSE,message=FALSE,eval=FALSE}
#============== WORKBOOK EXAMPLE ==============#
#Comparison of Three Standardization Methods

fig <- ggplot(analyte, aes(x = method, y = ppm) ) +
  geom_jitter(width = .2, colour = "#8c8c8c") +
  geom_errorbar(data = analytesummary, 
                aes(ymin = ppm, 
                    ymax = ppm), 
                width=.2, size = 1 ) + 
  geom_errorbar(data = analytesummary, 
                aes(ymin = ppm - se, 
                    ymax = ppm + se), 
                width = .3 ) +
  ylab("PPM" ) +
  xlab("Method") +
  scale_x_discrete(labels = c("Internal Standard", "Standard", "Standard addition")) + 
  annotate("segment", x = 3, xend = 3, 
           y = 185, yend = 188,
           colour = "black") +
  annotate("segment", x = 2, xend = 2, 
           y = 185, yend = 188,
           colour = "black") +
  annotate("segment", x = 3, xend = 2, 
           y = 188, yend = 188,
           colour = "black") +
  annotate("text", x = 2.5,  y = 190, 
           label = "***", size = 6) +
  annotate("segment", x = 1, xend = 1, 
           y = 200, yend = 197,
           colour = "black") +
  annotate("segment", x = 3, xend = 3, 
           y = 200, yend = 197,
           colour = "black") +
  annotate("segment", x = 1, xend = 3, 
           y = 200, yend = 200,
           colour = "black") +
  annotate("text", x = 2,  y = 202, 
           label = "***", size = 6) +
  theme(panel.background = element_rect(fill = "white")) +
  theme(axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"))
```

* *Tip* Using the argument `data = ...` in the `ggplot()` statement means that dataframe (indicated by `...`) will be used in all the geom *unless* they specify another dataframe. In this example you will need to use two dataframes: the raw data and the summarised data. Put one in the `ggplot()` and the other in an appropriate `geom` when you need to. 
* *Tip* To plot each individual point you can use [`geom_point()`](https://ggplot2.tidyverse.org/reference/geom_point.html) or [`goem_jitter`](https://ggplot2.tidyverse.org/reference/geom_jitter.html)
* *Tip* To plot the mean you can use `geom_point()` or I like to use a `geom_errorbar()`with arguments set so it is a single line. [Example](http://www-users.york.ac.uk/~er13/17C%20-%202018.yrk/pracs/06One-wayAnovaAndKW.html#illustrating_2)

### Response to cancer treatment

This example concerns the effect of patient genotype and their glutathione concentration on their sensitivity to cytoxic drugs.
Patients vary in their response to cancer treatment. This may be because sensitivity to cytotoxic (anti-cancer) drugs is influenced by genotype. However, glutathione (GSH) concentration is also implicated in treatment sensitivity. Researchers measure treatment sensitivity and GSH concentration for patients that had one of three alleles ("A2","AA01","B34"). The data are in [response.txt](../data/response.txt) and comprise the following variables:

* GSH: a continuous measure glutathione concentration
* sens: a continuous measure of treatment sensitivity in arbitrary units
* genotype: a factor with three levels,A2, AA01 and B34

![](../../pics/W.png) Save a copy of [response.txt](../data/response.txt). 

![](../../pics/R.png) Read it in and build a linear model to predict treatment sensitivity from GSH alone like this:

```{r}
resp <- read.table("../data/response.txt", header = T)

# Build a regression model to predict treatment sensitivity from GSH
# we will ignore genotype for a moment
mod <- lm(data = resp, sens ~ GSH)
summary(mod)
anova(mod)

# Basic interpretation
# There is a signifcant effect of GSH on treatment sensitivity - sensitivity increases by 1.70 units with every unit of GSH

```

![](../../pics/R.png) Create a figure appropriate to accompany this result. You may wish to discuss you choice with a friend/demonstrator.



```{r, message=FALSE, warning=FALSE, include=FALSE}
#============== WORKBOOK EXAMPLE ==============#
# since the explanatory variable is continuous, the analysis is a standard regession meaning the model is a straight line of best fit. 
# it makes sense to show all the data and the model
fig <- ggplot(resp, aes(x = GSH, y = sens) ) +
  geom_point() +
  stat_smooth(method = "lm", color = "black", se = FALSE) +
  ylab("Sensitivity to cytoxic drugs" ) +
  ylim(0, 40) +
  xlab("Glutathione concentration") +
  xlim(0, 6) +
  theme(panel.background = element_rect(fill = "white")) +
  theme(axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"))

```
* *Tip* [`stat_smooth()`](https://ggplot2.tidyverse.org/reference/geom_smooth.html) will add best fit lines

![](../../pics/R.png) Now build a linear model to predict treatment sensitivity from genotype alone like this:

```{r}

# model to predict treatment sensitivity from genotype
# this time we ignore GSH for a moment
mod <- lm(data = resp, sens ~ genotype)
summary(mod)
anova(mod)

# find the group means
respsummary <- summarySE(resp, measurevar = "sens", groupvars = c("genotype"))

# apply a post-hoc test to see where the differences lie
lsmeans(mod, pairwise ~ genotype)

# Basic interpretation
# There is a signifcant effect of genotype on treatment sensitivity and the biggest difference lies between A2 and B34 but this is not significant when the p value is adjusted for multiple comparison

```

![](../../pics/R.png) Create a figure appropriate to accompany this result. You may wish to discuss you choice with a friend/demonstrator.

```{r, message=FALSE, warning=FALSE, include=FALSE}
#============== WORKBOOK EXAMPLE ==============#
# since the explanatory variable is categories, you should plot the means and se for each group.  
# here's a figure which includes of all data and the means (i.e., the model)
fig <- ggplot(resp, aes(x = genotype, y = sens) ) +
  geom_jitter(width = .2, colour = "#8c8c8c") +
  geom_errorbar(data = respsummary, 
                aes(ymin = sens, 
                    ymax = sens), 
                width=.2, size = 1 ) + 
  geom_errorbar(data = respsummary, 
                aes(ymin = sens - se, 
                    ymax = sens + se), 
                width = .3 ) +
  ylab("Sensitivity to cytoxic drugs" ) +
  ylim(0, 40) +
  xlab("Genotype")+
  theme(panel.background = element_rect(fill = "white")) +
  theme(axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"))

```

![](../../pics/R.png) Now build a linear model to predict treatment sensitivity from *both* genotype and GSH concentration like this:

```{r}

# Build a model to predict treatment sensitivity from both genotype and GSH
mod <- lm(data = resp, sens ~ genotype * GSH)
summary(mod)
anova(mod)
# Basic interpretation
# there is a sig effect of genotype and a sig effect gsh but there is no interaction between them. this means the slope of the relationship between gsh and sens is the same for the three genotypes. the intercepts for the three genotypes differ. the model explains 60% of the variation in sensitivity

```

![](../../pics/R.png) Create a figure that has a line of best fit for each group separately on one graph suitable for black and white printing.  Googling might be needed.

```{r, message=FALSE, warning=FALSE, include=FALSE}
#============== WORKBOOK EXAMPLE ==============#
# 
fig <- ggplot(resp, aes(x = GSH, y = sens, shape = genotype, linetype = genotype) ) +
  geom_point() +
  stat_smooth(method = "lm", se = FALSE, colour = "black") +
  ylab("Sensitivity to cytoxic drugs" ) +
  ylim(22, 33) +
  xlab("Glutathione concentration") +
  xlim(2, 6) +
  theme(panel.background = element_rect(fill = "white")) +
  theme(axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        legend.key = element_rect(fill = "transparent", colour = "transparent"))

```

* *Tip* mapping a variable to an element like colour or shape in the `ggplot` `aes()` will mean you get different colours or shapes for each level in that variable for all the geoms in the plot
* *Tip* `linetype` is another aesthetic like colour and shape
* *Tip* Get rid of the grey background in a legend using [theme()](https://ggplot2.tidyverse.org/reference/theme.html)


![](../../pics/R.png) Can you also do as a panel of three figures?
```{r, message=FALSE, warning=FALSE, include=FALSE}
#============== WORKBOOK EXAMPLE ==============#
# black and white using shape
fig <- ggplot(resp, aes(x = GSH, y = sens) ) +
  geom_point(color = "black") +
  stat_smooth(method = "lm", se = FALSE, color = "black") +
  ylab("Sensitivity to cytoxic drugs" ) +
  ylim(0, 40) +
  xlab("Glutathione concentration") +
  xlim(0, 6) +
  theme(panel.background = element_rect(fill = "white")) +
  theme(axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black")) +
  facet_grid(. ~ genotype)

```

* *Tip* Separate panels are called facets in `ggplot` [facet_grid()](https://ggplot2.tidyverse.org/reference/facet_grid.html)


### Susceptibility to Chytrid infection

A group of researchers exposed 20 individuals of three genetically different strains of the diatom _Asterionella formosa_ to its chytrid parasite _Zygorhizidium planktonicum_ for fifteen replicates to determine whether their susceptibility to infection varied. Since infection rates are expected to be affected by temperature they measured infection across a range environmentally relevant temperatures. 

The data are in [diatominf.txt](../data/diatominf.txt) and include the following variables:
  
* temp   : a continuous measure of temperature in degrees C
* strains: a factor w/ 3 levels "strainA","strainB", "strainC"
* prop   : the proportion of the twenty diatoms that were infected

The goal was to determine whether temperature and strain could predict the probability of infection. This a binomial glm with the response variable in a different format than you've seen before. Instead of being zeros or ones for single cases, it's a proportion for groups of cases.

![](../../pics/W.png) Save a copy of [diatominf.txt](../data/diatominf.txt). 

![](../../pics/R.png) Read it in build a glm model to predict Chytrid infection from temperature and strain:

```{r message=FALSE, warning=FALSE}
diatom <- read.table("../data/diatominf.txt", header = T)

# Build a glm model to predictChytrid infection from temperature and strain
# don't worry about the warning. R is just checking you realise you have proportions
mod1 <- glm(data = diatom, prop ~ temp * strains, family = binomial)
summary(mod1)
anova(mod1, test = "Chisq")
exp(mod1$coefficients)
# basic interpretation
# temperature has an effect; there no difference between the strains and temperature effects all strains in the same way

```

![](../../pics/R.png) Create a figure that has all the tested explanatory effects (regardless of any significance) on one graph.  Suitable for colour printing is fine. 

```{r, message=FALSE, warning=FALSE, include=FALSE}
#============== WORKBOOK EXAMPLE ==============#
# 
fig <- ggplot(diatom, aes(x = temp, y = prop, color = strains) ) +
  geom_point() +
  stat_smooth(method = "glm", method.args = "binomial", se = FALSE) +
  ylab("Proportion of individuals infected" ) +
  xlab("Temperature") +
  theme(panel.background = element_rect(fill = "white")) +
  theme(axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        legend.key = element_rect(fill = "transparent", colour = "transparent"))

```


### Skin micro-organisms

Human skin is colonised by a diverse collection of micro-organisms which vary considerably between individuals.  The presence or absence of a particular micro-organism on the skin of a number of individuals was determined along with variables which might influence presence. The data are in [microrg.txt](../data/microrg.txt) and comprise following variables:

* melanin : a continuous measure of the concentration of melanin in the individual's skin determined by the SR method
* age     : the individual's age in years (to one tenth of a year) 
* presence: whether the micro-organism is absent (0) or present (1) on the individual's skin
* gender  : female or male

The goal of analysis was to determine if the presence of the micro-organism could be predicted from an individual's gender, melanin concentration or age.

![](../../pics/W.png) Save a copy of [microrg.txt](../data/microrg.txt). 

![](../../pics/R.png) Read it in build a glm model to predict the presence of the micro-organism from an individual's gender, melanin concentration or age:
```{r}
# read in data
micro <- read.table("../data/microrg.txt",header=T)
str(micro)
# build and examine model. the repsonse is binary so it is binomial
mod <- glm(data = micro, presence ~ gender * melanin * age, family = binomial)
summary(mod)
anova(mod,test="Chisq")

# basic interpretation
# only gender and melanin seem signifcant: the presence of microorganisms seems to be associated with lower melanin and male gender.

```
![](../../pics/R.png) Create a figure that has shows the effect of gender and melanin on one graph. Suitable for colour printing is fine. 

```{r, message=FALSE, warning=FALSE, include=FALSE}
#============== WORKBOOK EXAMPLE ==============#
# 
fig <- ggplot(data = micro, aes(x = melanin, y = presence, color = gender) ) +
  geom_point() +
  stat_smooth(method = "glm", method.args = "binomial", se = FALSE) +
  ylab("Presence of microorganisms" ) +
  xlab("Melanin") +
  theme(panel.background = element_rect(fill = "white")) +
  theme(axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        legend.key = element_rect(fill = "transparent", colour = "transparent"))

```


![](../../pics/R.png) Create a figure that has shows the effect of gender and age on one graph. Suitable for colour printing is fine.

```{r, message=FALSE, warning=FALSE, include=FALSE}
#============== WORKBOOK EXAMPLE ==============#
fig <- ggplot(data = micro, aes(x = age, y = presence, color = gender) ) +
  geom_point() +
  stat_smooth(method = "glm", method.args = "binomial", se = FALSE) +
  ylab("Presence of microorganisms" ) +
  xlab("Age") +
  theme(panel.background = element_rect(fill = "white")) +
  theme(axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        legend.key = element_rect(fill = "transparent", colour = "transparent"))


```

![](../../pics/R.png) Which of these figures do you think is most suitable for the the results of the analysis?

<!-- Probably the first with melanin since age was not significant -->


# The Rmd file

[Rmd file](QCworkshop4DataViz.Rmd)

# Objectives from previous sessions

[Thinking about data generation and processing before experimental design and analysis](QCworkshop1DataAnalysis.html)

* Recognise non-independence and pseudo replication in experimental design
* Select appropriately, and apply some methods to make data comparable
* Design experiments to take account of these

[Building from Linear Models to Generalised Linear Models Part 1](QCworkshop2DataAnalysis.html)

* Explain the the link between t-tests, ANOVA and regression
* Appropriately apply linear models using `lm()`
* Interpret the results using `summary()` and `anova()` and relate them to the outputs of `t.test()` and `aov()`

[Building from Linear Models to Generalised Linear Models: Part 2](QCworkshop3DataAnalysis.html)

* Explain the link between the general linear models and the generalised linear model
* Recognise where a generalised linear model would be appropriate and apply `glm()`
* Determine which effects are significant using using `summary()` and `anova()`

[Data Visualisation](QCworkshop4DataViz.html)

* explain what is important in choosing a figure
* determine which variables are best mapped to which elements of a figure
* explain the fundamentals of ggplot and recognise it as a 'tidy' package
* create, with ggplot, appropriate figures to accompany lm and glm analyses of up to three explanatory variables which show the data, the main statistical model and the results of any post-hoc testing as appropriate.


# Q and C Overview

[Quantitative and Computational skills Intro.pdf](../slides/Quantitative and Computational skills Intro.pdf)

This series of workshops is designed to allow you to consolidate and extend your quantitative and computational skills. We build on the experimental design and data analysis skills developed in Stage 1 by introducing you to additional methods of data analysis as well as those for data handling and visualisation. 

In addition, approaches for problems in time will be introduced.

A choice of examples drawn from all areas of the biosciences will allow you to hone your skills on problems of interest before applying them to the experimental design and bioscience techniques strands in this module as well as work in other modules and projects.

Assessment is through statistical and quantitative problem solving approaches related to Experimental Design and Bioscience Techniques.


![](../../pics/58Iend.png)


